<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kobook.mappers.bookMapper">

	<insert id="create" parameterType="BookVO">
		insert into book(
		book_id,book_name,book_o_price,book_m_price,book_kind,book_edition,book_publish,book_hash,book_safe_yn,book_content,
		book_date,book_status,book_sell_state,book_img,person_id

		)values(
		book_id_seq.nextval, #{book_name}, #{book_o_price},
		#{book_m_price},#{book_kind},
		#{book_edition},#{book_publish},
		#{book_hash}, #{book_safe_yn}, #{book_content},
		SYSDATE,#{book_status},#{book_sell_state},#{book_img},#{person_id}
		)
	</insert>

	<select id="listCriteria" resultType="BookVO" parameterType="SearchCriteria">
    <![CDATA[
          select 
            *
          from 
            book             
            where book_id > 0
      ]]>
		<include refid="search"></include>
		<include refid="sort"></include>

	</select>

	<select id="directListCriteria" resultType="BookVO" parameterType="SearchCriteria">
	<![CDATA[
     select b.book_id, b.book_name, b.book_o_price,b.book_m_price,b.book_kind,b.book_edition, b.book_publish, 
            b.book_hash, b.book_safe_yn, b.book_content,b.book_date, b.book_status,b.book_sell_state, b.book_img,
            p.person_id
      from book b, person p
      where b.person_id=p.person_id
      and b.book_safe_yn='N'
      ]]>
       <include refid="locationsearch"></include>
	</select>
	
		<select id="safeListCriteria" resultType="BookVO" parameterType="SearchCriteria">
	<![CDATA[
     select b.book_id, b.book_name, b.book_o_price,b.book_m_price,b.book_kind,b.book_edition, b.book_publish, 
            b.book_hash, b.book_safe_yn, b.book_content,b.book_date, b.book_status,b.book_sell_state, b.book_img,
            p.person_id
      from book b, person p
      where b.person_id=p.person_id
      and b.book_safe_yn='Y'
      ]]>
            <include refid="locationsearch"></include>
	</select>


	<select id="sellPersonList" resultType="BookVO">
		<![CDATA[
		select * 
		from book
		where person_id=#{person_id}
		]]>
		<!--  -->
	</select>

	<select id="getPersonIdByBookId" resultType="Integer">
		select person_id
		from book
		where book_id = #{book_id}
	</select>
	
	<!--?먮ℓ?먯젙蹂? -->
	<select id="readSellPerson" resultType="PersonDTO">
    select person_id, person_email,person_sell_grade, person_avg from person where person_id=#{person_id}
	</select>
	
	
	<!--由щ럭?묒꽦-->
	<insert id="reviewCreate" parameterType="ReviewVO">
	insert into review(
	review_id, review_content, review_date, review_star, pay_id
	)
	values(
		review_id_seq.nextval, #{review_content}, SYSDATE,
		#{review_star},#{pay_id},
		)
	</insert>
	
	<!--寃곗젣踰덊샇 媛?몄삤湲? -->
<!-- 	<select id="getPayId" resultType="Integer">
	select p.pay_id 
	from pay p, book_order o
	where p.ORDER_ID = o.ORDER_ID
	and p.pay_id=#{pay_id}
	</select> -->
	

<sql id="locationsearch">
<if test="keyword !=null">
and p.person_address like '%'|| #{keyword}||'%'
</if>
</sql>

	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 't'.toString()">
				and book_name like '%'|| #{keyword}||'%'
			</if>
			<if test="searchType == 'c'.toString()">
				and book_content like '%'|| #{keyword}||'%'
			</if>
			<if test="searchType == 'w'.toString()">
				and book_hash like '%'|| #{keyword}||'%'
			</if>
			<if test="searchType == 'tc'.toString()">
				and ( book_name like '%'|| #{keyword}||'%' OR
				book_content like
				'%'||
				#{keyword}||'%')
			</if>
			<if test="searchType == 'cw'.toString()">
				and ( book_name like '%'|| #{keyword}||'%' OR book_hash
				like
				'%'||
				#{keyword}||'%')
			</if>
			<if test="searchType == 'tcw'.toString()">
				and ( book_name like '%'|| #{keyword}||'%'
				OR
				book_content
				like
				'%'|| #{keyword}||'%'
				OR
				book_hash like '%'|| #{keyword}||'%')
			</if>
		</if>
	</sql>


	<sql id="sort">
		<if test="sortType != null">
			<if test="sortType == 'd'.toString()">
			   order by book_date desc 
			 </if>
			<if test="sortType == 's'.toString()">
				order by book_safe_yn desc
			</if>
			<if test="sortType == 'p'.toString()"> order
				by book_m_price
			</if>
			<if test="sortType == 'b'.toString()"> order by book_status
			</if>
		</if>
	</sql>
	
	


	<select id="read" resultType="BookVO">
		select
		*
		from
		book
		where book_id =
		#{book_id}
	</select>


	<update id="update" parameterType="BookVO">
		UPDATE book SET
		book_name=#{book_name},book_m_price=#{book_m_price},
		book_o_price=#{book_o_price},
		book_sell_state=#{book_sell_state},
		book_status=#{book_status},book_hash=#{book_hash},
		book_safe_yn=#{book_safe_yn},
		book_content=#{book_content},book_edition=#{book_edition},
		book_publish=#{book_publish},book_img=#{book_img}
		WHERE
		book_id=#{book_id}

	</update>


	<select id="countPaging" resultType="int">
   <![CDATA[
      select count(book_id) from book where book_id>0    
   ]]>

		<include refid="search"></include>
		 <include refid="sort"></include>
	</select>


	<insert id="pickcreate" parameterType="PickVO">
		insert into pick(
		pick_id, person_id, book_id, pick_state

		)values(
		pick_id_seq.nextval, #{person_id}, #{book_id},'Y'
		)
	</insert>


	<!-- <insert id="addAttach" parameterType="BookFileVO"> insert into book_attach(book_file_name, 
		book_id) values(#{book_file_name},#{book_id}) </insert> <select id="maxNum" 
		resultType="int"> select MAX(book_id) from book </select> <select id="getAttach" 
		resultType="string"> select book_file_name from book_attach where book_id 
		= #{book_id} order by book_date </select> <delete id="deleteAttach"> delete 
		from book_attach where book_id=#{book_id} </delete> <insert id="replaceAttach"> 
		insert into book_attach(book_file_name, book_id) values(#{book_file_name},#{book_id}) 
		</insert> -->
		
		
	<!-- <select id="payPerson" resultType="PersonVO" parameterType="int">
		SELECT *
		FROM person
		WHERE person_id = #{person_id}
	</select> -->





</mapper>